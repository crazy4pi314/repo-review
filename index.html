<html>
    <head>
        <meta charset="utf-8" name="viewport" content="initial-scale=1, width=device-width"/>
        <script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js" crossorigin></script>
        <!--
        <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/@mui/material@v5.6.1/umd/material-ui.production.min.js" crossorigin></script>
        -->
        <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
        <script src="https://unpkg.com/@mui/material@v5.6.1/umd/material-ui.development.js" crossorigin></script>

        <!-- Can remove this for a pre-processor -->
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js" crossorigin></script>
        <!-- Fonts to support Material Design -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
        <!-- Icons to support Material Design -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    </head>

    <body>
        <div id="root"></div>
        <script type="text/babel">
            async function main() {
                const pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.20.0/full/"
                });

                await pyodide.loadPackage('micropip');
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install("scikit_hep_repo_review==0.2.0")
                `);

                function Results(props) {
                    const results_components = props.results.map(result => {
                        let details = result.state == false ? result.err_msg : null;
                        let color = result.state == false ? 'error' : result.state == null ? 'warning' : 'text.primary';
                        let icon = <MaterialUI.Icon color={color}>{result.state == false ? 'error' : result.state == null ? 'warning' : 'check_circle'}</MaterialUI.Icon>;
                        let msg = (
                            <React.Fragment>
                                <MaterialUI.Typography
                                    sx={{ display: 'inline' }}
                                    component="span"
                                    variant="body2"
                                    color="text.primary"
                                >
                                    {result.name + ": "}
                                </MaterialUI.Typography>
                                {result.description}
                            </React.Fragment>
                        )
                        return (
                            <MaterialUI.ListItem disablePadding key={result.name}>
                                <MaterialUI.ListItemButton>
                                    <MaterialUI.ListItemIcon>
                                        {icon}
                                    </MaterialUI.ListItemIcon>
                                    <MaterialUI.ListItemText primary={msg} secondary={details} color={color} />
                                </MaterialUI.ListItemButton>
                            </MaterialUI.ListItem>
                        );
                    });

                    return (
                        <MaterialUI.Box sx={{bgcolor: 'background.paper'}}>
                            <MaterialUI.List>{results_components}</MaterialUI.List>
                        </MaterialUI.Box>
                    );
                }

                class App extends React.Component {
                    constructor(props) {
                        super(props);
                        this.state = {
                            results: [],
                            repo: "",
                            branch: "",
                        };
                    }

                    handleCompute() {
                        if (this.state.repo === "" || this.state.branch === "") {
                            alert("Please enter a repo and branch");
                            return;
                        }
                        console.log("Clicked compute");
                        pyodide.runPython(`
                            from pyodide.http import open_url
                            val = open_url("/app.py")
                            with open("app.py", "w") as f:
                                f.write(val.read())
                        `);
                        let results_dict = pyodide.runPython(`
                            from scikit_hep_repo_review.processor import process
                            from app import GHPath
                            package = GHPath(repo="scikit-hep/hist", branch="main")
                            results_dict = process(package)
                            results_dict
                        `);

                        var results = [];
                        for(let res of results_dict) {
                            let vals = results_dict.get(res);
                            for(let val of vals) {
                                results.push({
                                    name: val.name.toString(),
                                    description: val.description.toString(),
                                    state: val.result,
                                    err_msg: val.err_msg.toString()
                                })
                            }
                        }

                        this.setState({results: results, repo: this.state.repo, branch: this.state.branch});
                    }


                    render() {
                        let common_branches = ["main", "master", "develop", "stable"];
                        return (
                            <MaterialUI.Box>
                            <MaterialUI.Paper elevation={3}>
                                <MaterialUI.Stack direction="row" spacing={2} justifyContent="center" alignItems="center">
                                    <MaterialUI.TextField
                                        id="repo-select"
                                        label="Org/Repo"
                                        variant="outlined"
                                        onChange={(e) => this.setState({repo: e.target.value})}
                                    />
                                    <MaterialUI.Autocomplete
                                        disablePortal
                                        id="branch-select"
                                        options={common_branches}
                                        sx={{ width: 300 }}
                                        freeSolo = {true}
                                        renderInput={(params) => <MaterialUI.TextField {...params} label="Branch" variant="outlined" />}
                                        onChange={(e) => this.setState({branch: e.target.value})}
                                    />
                                    <MaterialUI.Button onClick={() => this.handleCompute()} variant="contained" size="large">Compute!</MaterialUI.Button>
                                </MaterialUI.Stack>
                                <Results results={this.state.results} />
                            </MaterialUI.Paper>
                            </MaterialUI.Box>
                        );
                    }
                }

                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<App />);
            }

            main();

        </script>
    </body>
</html>
